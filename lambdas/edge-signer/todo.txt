todo: see if possible to inline all this code into a cloudfront function instead......
will need to see there is any missing JS core functions....

